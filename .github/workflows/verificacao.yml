# Nome do Workflow que aparece na aba Actions do GitHub
name: CI/CD de Verificação e Deploy - GitFlow Master

# Define quando a automação será executada
on:
  push:
    branches: [main, develop] # Roda ao enviar código para main ou develop
  pull_request:
    branches: [main] # Roda ao abrir um pedido de mesclagem para a main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # Usa a versão mais recente do Ubuntu

    steps:
      # 1. FAZ O DOWNLOAD DO CÓDIGO
      - name: Checkout do Código
        uses: actions/checkout@v3

      # 2. CONFIGURA O AMBIENTE
      - name: Configurar Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # 3. INSTALA AS DEPENDÊNCIAS
      - name: Instalar Dependências
        run: |
          python -m pip install --upgrade pip
          pip install flask gunicorn flask-login
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # 4. TESTE DE SINTAXE (LINT)
      - name: Verificação de Sintaxe (Lint)
        run: |
          python -m py_compile run.py
          python -m compileall app/

      # 5. DEPLOY AUTOMÁTICO (CONTINUOUS DEPLOYMENT)
      - name: Deploy no PythonAnywhere
        if: github.ref == 'refs/heads/main'
        env:
          PA_API_TOKEN: ${{ secrets.PA_API_TOKEN }}
          PA_USERNAME: ${{ secrets.PA_USERNAME }}
        run: |
          # A) COMANDO DE PULL - AJUSTADO PARA O NOME COM HÍFEN (-)
          curl -X POST "https://www.pythonanywhere.com/api/v0/user/$PA_USERNAME/consoles/" \
            -H "Authorization: Token $PA_API_TOKEN" \
            --data "executable=bash&arguments=-c 'cd ~/gitflow-master && git pull origin main'"

          # B) COMANDO DE RELOAD - Reinicia o servidor Web
          curl -X POST "https://www.pythonanywhere.com/api/v0/user/$PA_USERNAME/webapps/$PA_USERNAME.pythonanywhere.com/reload/" \
            -H "Authorization: Token $PA_API_TOKEN"
